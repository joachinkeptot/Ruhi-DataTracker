import React, { useMemo } from "react";
import { useApp } from "./AppContext";

const Analytics: React.FC = () => {
  const { people, activities, families } = useApp();

  // Calculate core metrics
  const metrics = useMemo(() => {
    // Age group breakdown
    const ageGroupCounts: Record<string, number> = {};
    people.forEach((p) => {
      ageGroupCounts[p.ageGroup] = (ageGroupCounts[p.ageGroup] || 0) + 1;
    });

    // Activity type breakdown
    const activityCounts: Record<string, number> = {};
    activities.forEach((a) => {
      activityCounts[a.type] = (activityCounts[a.type] || 0) + 1;
    });

    // People with connections
    const connectedPeople = people.filter(
      (p) => p.connectedActivities.length > 0,
    ).length;

    // Total home visits and conversations
    const totalHomeVisits = people.reduce(
      (sum, p) => sum + (p.homeVisits?.length || 0),
      0,
    );
    const totalConversations = people.reduce(
      (sum, p) => sum + (p.conversations?.length || 0),
      0,
    );

    // Learning progress
    const peopleWithRuhi = people.filter(
      (p) => (p.studyCircleBooks?.length || 0) > 0,
    ).length;
    const peopleWithJY = people.filter(
      (p) => (p.jyTexts?.length || 0) > 0,
    ).length;

    // Area breakdown
    const areaCounts: Record<string, number> = {};
    people.forEach((p) => {
      areaCounts[p.area] = (areaCounts[p.area] || 0) + 1;
    });

    return {
      totalPeople: people.length,
      totalActivities: activities.length,
      totalFamilies: families.length,
      ageGroupCounts,
      activityCounts,
      connectedPeople,
      disconnectedPeople: people.length - connectedPeople,
      totalHomeVisits,
      totalConversations,
      peopleWithRuhi,
      peopleWithJY,
      areaCounts,
    };
  }, [people, activities, families]);

  return (
    <div id="analytics-report" className="analytics">
      {/* Time Period Selector */}
      <div className="analytics__header">
        <div className="analytics__period-selector">
          <button
            className={`btn ${timePeriod === "week" ? "btn--active" : ""}`}
            onClick={() => {
              setTimePeriod("week");
              setShowCustomRange(false);
            }}
          >
            Last Week
          </button>
          <button
            className={`btn ${timePeriod === "month" ? "btn--active" : ""}`}
            onClick={() => {
              setTimePeriod("month");
              setShowCustomRange(false);
            }}
          >
            Last Month
          </button>
          <button
            className={`btn ${timePeriod === "quarter" ? "btn--active" : ""}`}
            onClick={() => {
              setTimePeriod("quarter");
              setShowCustomRange(false);
            }}
          >
            Last Quarter
          </button>
          <button
            className={`btn ${timePeriod === "custom" ? "btn--active" : ""}`}
            onClick={() => setShowCustomRange(!showCustomRange)}
          >
            Custom Range
          </button>
        </div>

        {/* Custom Range Picker */}
        {showCustomRange && (
          <div className="analytics__custom-range">
            <input
              type="date"
              value={customRange.start.toISOString().split("T")[0]}
              onChange={(e) =>
                setCustomRange({
                  ...customRange,
                  start: new Date(e.target.value),
                })
              }
            />
            <span>to</span>
            <input
              type="date"
              value={customRange.end.toISOString().split("T")[0]}
              onChange={(e) =>
                setCustomRange({
                  ...customRange,
                  end: new Date(e.target.value),
                })
              }
            />
            <button
              className="btn"
              onClick={() => {
                setTimePeriod("custom");
                setShowCustomRange(false);
              }}
            >
              Apply
            </button>
          </div>
        )}
      </div>

      {/* Metrics Cards */}
      <div className="analytics__metrics">
        <div className="metrics-card">
          <h3>People</h3>
          <div className="metrics-card__value">{metrics.totalPeople}</div>
          <div className="metrics-card__detail">
            <span className="metrics-card__label">New this period:</span>
            <span className="metrics-card__number">
              {metrics.newPeopleThisPeriod}
            </span>
          </div>
          <div
            className={`metrics-card__change ${metrics.peoplePercentChange >= 0 ? "positive" : "negative"}`}
          >
            {metrics.peoplePercentChange >= 0 ? "+" : ""}
            {metrics.peoplePercentChange}% vs previous
          </div>
        </div>

        <div className="metrics-card">
          <h3>Activities</h3>
          <div className="metrics-card__value">{metrics.totalActivities}</div>
          <div className="metrics-card__detail">
            <span className="metrics-card__label">New this period:</span>
            <span className="metrics-card__number">
              {metrics.newActivitiesThisPeriod}
            </span>
          </div>
          <div className="metrics-card__detail">
            <span className="metrics-card__label">Total connections:</span>
            <span className="metrics-card__number">
              {metrics.totalConnections}
            </span>
          </div>
        </div>

        <div className="metrics-card">
          <h3>Learning</h3>
          <div className="metrics-card__detail">
            <span className="metrics-card__label">Ruhi completions:</span>
            <span className="metrics-card__number">
              {metrics.ruhiCompletions}
            </span>
          </div>
          <div className="metrics-card__detail">
            <span className="metrics-card__label">JY completions:</span>
            <span className="metrics-card__number">
              {metrics.jyCompletions}
            </span>
          </div>
          <div className="metrics-card__total">
            {metrics.ruhiCompletions + metrics.jyCompletions} total
          </div>
        </div>

        <div className="metrics-card">
          <h3>Engagement</h3>
          <div className="metrics-card__detail">
            <span className="metrics-card__label">Home visits:</span>
            <span className="metrics-card__number">
              {metrics.homeVisitsCount}
            </span>
          </div>
          <div className="metrics-card__detail">
            <span className="metrics-card__label">Conversations:</span>
            <span className="metrics-card__number">
              {metrics.conversationsCount}
            </span>
          </div>
          <div className="metrics-card__detail">
            <span className="metrics-card__label">Families contacted:</span>
            <span className="metrics-card__number">
              {metrics.familiesContactedCount}
            </span>
          </div>
        </div>
      </div>

      {/* Charts */}
      <div className="analytics__charts">
        <div className="analytics__chart-group">
          <div className="analytics__chart">
            <h3>People Added Over Time</h3>
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={peopleByWeek}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="value"
                  stroke="#4cc9f0"
                  name="New People"
                />
              </LineChart>
            </ResponsiveContainer>
          </div>

          <div className="analytics__chart">
            <h3>Activity Attendance by Type</h3>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={activityByType}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Bar dataKey="value" fill="#72ddf7" name="Count" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="analytics__chart-group">
          <div className="analytics__chart">
            <h3>Participation Status Breakdown</h3>
            <ResponsiveContainer width="100%" height={300}>
              <AreaChart data={participationByWeek}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Area
                  type="monotone"
                  dataKey="active"
                  stackId="1"
                  fill="#90e0ef"
                  name="Active"
                />
                <Area
                  type="monotone"
                  dataKey="inactive"
                  stackId="1"
                  fill="#cad2c5"
                  name="Inactive"
                />
                <Area
                  type="monotone"
                  dataKey="new"
                  stackId="1"
                  fill="#00b4d8"
                  name="New"
                />
              </AreaChart>
            </ResponsiveContainer>
          </div>

          <div className="analytics__chart">
            <h3>Learning Completions by Week</h3>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={learningByWeek}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Bar dataKey="ruhi" fill="#4cc9f0" name="Ruhi" />
                <Bar dataKey="jy" fill="#72ddf7" name="JY" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>

      {/* Heat Map */}
      <div className="analytics__heatmap">
        <h3>Home Visits by Area Over Time</h3>
        <div className="heatmap-container">
          {heatmapData.length > 0 ? (
            <table className="heatmap-table">
              <tbody>
                {heatmapData.map((row) => (
                  <tr key={row.area}>
                    <td className="heatmap-label">{row.area}</td>
                    {Array.from({ length: 12 }).map((_, weekIdx) => {
                      const visitCount =
                        row.weeks.find((w) => w.week === weekIdx)?.count || 0;
                      const intensity = Math.min(visitCount / 3, 1);
                      const color = `rgba(76, 201, 240, ${intensity})`;
                      return (
                        <td
                          key={`${row.area}-${weekIdx}`}
                          className="heatmap-cell"
                          style={{ backgroundColor: color }}
                          title={`${row.area} - Week ${weekIdx + 1}: ${visitCount} visits`}
                        >
                          {visitCount > 0 && visitCount}
                        </td>
                      );
                    })}
                  </tr>
                ))}
              </tbody>
            </table>
          ) : (
            <p className="heatmap-empty">
              No home visit data available for selected period
            </p>
          )}
        </div>
      </div>

      {/* Insights */}
      <div className="analytics__insights">
        <h3>Key Insights</h3>
        <ul className="insights-list">
          {insights.map((insight, idx) => (
            <li key={idx} className="insight-item">
              {insight}
            </li>
          ))}
        </ul>
      </div>

      {/* Export Button */}
      <div className="analytics__actions">
        <button className="btn btn--primary" onClick={handleExportPDF}>
          üìä Export as PDF
        </button>
      </div>
    </div>
  );
};

export default Analytics;
className="analytics">
      <h2>Community Overview</h2>

      {/* Summary Cards */}
      <div className="analytics__summary">
        <div className="summary-card">
          <h3>üìä Totals</h3>
          <div className="summary-grid">
            <div>
              <strong>{metrics.totalPeople}</strong> People
            </div>
            <div>
              <strong>{metrics.totalFamilies}</strong> Families
            </div>
            <div>
              <strong>{metrics.totalActivities}</strong> Activities
            </div>
          </div>
        </div>

        <div className="summary-card">
          <h3>üë• Age Groups</h3>
          <div className="breakdown-list">
            {Object.entries(metrics.ageGroupCounts)
              .sort(([, a], [, b]) => b - a)
              .map(([age, count]) => (
                <div key={age} className="breakdown-item">
                  <span className={`chip chip--age-${age}`}>
                    {age === "JY" ? "JY" : age.charAt(0).toUpperCase() + age.slice(1)}
                  </span>
                  <strong>{count}</strong>
                </div>
              ))}
          </div>
        </div>

        <div className="summary-card">
          <h3>üéØ Activities</h3>
          <div className="breakdown-list">
            {Object.entries(metrics.activityCounts)
              .sort(([, a], [, b]) => b - a)
              .map(([type, count]) => (
                <div key={type} className="breakdown-item">
                  <span>{type}</span>
                  <strong>{count}</strong>
                </div>
              ))}
          </div>
        </div>

        <div className="summary-card">
          <h3>üîó Connections</h3>
          <div className="summary-grid">
            <div>
              <strong>{metrics.connectedPeople}</strong> Connected
            </div>
            <div>
              <strong>{metrics.disconnectedPeople}</strong> Not Connected
            </div>
            <div className="summary-percentage">
              {metrics.totalPeople > 0
                ? Math.round((metrics.connectedPeople / metrics.totalPeople) * 100)
                : 0}
              % participation
            </div>
          </div>
        </div>
      </div>

      {/* Engagement Section */}
      <div className="analytics__section">
        <h3>üìù Engagement</h3>
        <div className="engagement-stats">
          <div className="stat-item">
            <div className="stat-value">{metrics.totalHomeVisits}</div>
            <div className="stat-label">Home Visits</div>
          </div>
          <div className="stat-item">
            <div className="stat-value">{metrics.totalConversations}</div>
            <div className="stat-label">Conversations</div>
          </div>
          <div className="stat-item">
            <div className="stat-value">
              {metrics.totalHomeVisits + metrics.totalConversations}
            </div>
            <div className="stat-label">Total Interactions</div>
          </div>
        </div>
      </div>

      {/* Learning Section */}
      <div className="analytics__section">
        <h3>üìö Learning Progress</h3>
        <div className="learning-stats">
          <div className="stat-item">
            <div className="stat-value">{metrics.peopleWithRuhi}</div>
            <div className="stat-label">People with Ruhi Books</div>
          </div>
          <div className="stat-item">
            <div className="stat-value">{metrics.peopleWithJY}</div>
            <div className="stat-label">People with JY Texts</div>
          </div>
        </div>
      </div>

      {/* Area Breakdown */}
      <div className="analytics__section">
        <h3>üìç By Area</h3>
        <div className="area-breakdown">
          {Object.entries(metrics.areaCounts)
            .sort(([, a], [, b]) => b - a)
            .map(([area, count]) => (
              <div key={area} className="area-item">
                <div className="area-name">{area}</div>
                <div className="area-bar">
                  <div
                    className="area-bar-fill"
                    style={{
                      width: `${(count / metrics.totalPeople) * 100}%`,
                    }}
                  />
                </div>
                <div className="area-count">{count}</div>
              </div>
            ))}
        </div